from scapy.all import *
from colorama import Fore
import os
import sys
import requests
from bs4 import BeautifulSoup
 
description = r"""
         ,
         )\
        /  \
       '  # '
       ',  ,'
         `'
         ,
         )\
        /  \
       '  ~ '
       ',  ,'
         `'
upnp.py - UPnP Vulnerability Check
Example: python upnpcheck.py <Target IP>"""
print (description)

if len(sys.argv) is 1 or len(sys.argv) > 3: 
    print(Fore.RED+"Example Reference"+Fore.RESET)
    sys.exit()
 
SSDPserver=sys.argv[1]
 
def ssdp(): 
    payload = "M-SEARCH * HTTP/1.1\r\n" \
    "HOST:"+SSDPserver+":1900\r\n" \
    "ST:upnp:rootdevice\r\n" \
    "MAN: \"ssdp:discover\"\r\n" \
    "MX:2\r\n\r\n"
 
    ssdpRequest = IP(dst=SSDPserver) / UDP(sport=1900, dport= 1900) / payload
    resp=sr1(ssdpRequest, timeout=1, verbose=0)
    print(Fore.LIGHTBLUE_EX+'-------------------------------- UPnP Service Checking... ------------------------------'+Fore.RESET)
    if resp:
        print('************ '+SSDPserver+' : '+Fore.RED+'UPnP Service is Open!!!' + Fore.RESET)
        str1=str(resp[Raw])
        return str1
    else:
        print('************ '+SSDPserver +Fore.LIGHTBLUE_EX+": UPnP Service is not open"+Fore.RESET)
        sys.exit()
 
def filecontrol(location): 
    f=open("service.txt",'w')
    f.write(location)
    f.close()
    os.system("cat service.txt | grep -i location| awk '{print $2}' > service2.txt; rm service.txt")
    a=os.system("cat service2.txt | grep -i http > /dev/null")
    if a is not 0:
        print(Fore.LIGHTBLUE_EX+'---------------------------------------- Result --------------------------------------'+Fore.RESET)
        print('************ '+Fore.LIGHTBLUE_EX+"The UPnP service is not vulnerable." + Fore.RESET)
        sys.exit()
    f2=open("service2.txt",'r')
    url=f2.readline().replace("\r\n",'')
    f2.close()
    os.system("rm service2.txt")
    return url
 
def packet(url):
    login_url=url
    s=requests.session()
    resp=s.get(login_url)
    soup=BeautifulSoup(resp.text,'lxml')
    print(Fore.LIGHTBLUE_EX+'---------------------------------------- Result --------------------------------------'+Fore.RESET)
    if re.search('WANIPConnection', str(soup)):
        print('************ '+Fore.RED+"The UPnP service is vulnerable." + Fore.RESET)
    else:
        print('************ '+Fore.LIGHTBLUE_EX+"The UPnP service is not vulnerable." + Fore.RESET)
 
if __name__ == "__main__":
    location=ssdp()
    url=filecontrol(location)
    packet(url)
