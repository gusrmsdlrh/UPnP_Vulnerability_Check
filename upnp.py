from scapy.all import *
from colorama import *
import os
import sys
#import requests
#from bs4 import BeautifulSoup
 
description = r"""
         ,
         )\
        /  \
       '  # '
       ',  ,'
         `'
         ,
         )\
        /  \
       '  ~ '
       ',  ,'
         `'
upnp.py - UPnP Vulnerability Check"""
print (description)

if len(sys.argv) is not 2: 
    print("")
    print(Fore.YELLOW+"Example: python upnpcheck.py <Target IP>"+Fore.RESET)
    sys.exit()
 
SSDPserver=sys.argv[1]
 
def ssdp(): 
    payload = "M-SEARCH * HTTP/1.1\r\n" \
    "HOST:239.255.255.250:1900\r\n" \
    "ST:upnp:rootdevice\r\n" \
    "MAN: \"ssdp:discover\"\r\n" \
    "MX:2\r\n\r\n"
 
    ssdpRequest = IP(dst=SSDPserver) / UDP(sport=1900, dport= 1900) / payload
    resp=sr1(ssdpRequest, timeout=1, verbose=0)
    print
    print(Fore.CYAN+'[-] UPnP Service Checking... '+Fore.RESET)
    if (str(type(resp)) == "<type 'NoneType'>") or resp[IP].proto == 1:
        print(Fore.YELLOW+'[-] '+SSDPserver +": UPnP Service is not open"+Fore.RESET)
        print("")
    else:
        print(Back.RED+'[*] '+SSDPserver+' : '+'UPnP Service is Open!!!' + Back.RESET)
        print ""
        print("---------------Imformation----------------")
        print ""
        str1=str(resp[Raw])
        print (Fore.YELLOW+str1+Fore.RESET)
        print("-----------------------------------------")
        #return str1
#print "--------------------------------------------"
#def filecontrol(location): 
#    f=open("service.txt",'w')
#    f.write(location)
#    f.close()
#    os.system("cat service.txt | grep -i location| awk '{print $2}' > service2.txt; rm service.txt")
#    a=os.system("cat service2.txt | grep -i http > /dev/null")
#    if a is not 0:
#        print(Fore.CYAN+'[-] UPnP Service RESULT'+Fore.RESET)
#        print(Fore.YELLOW+"[-] The UPnP service is not vulnerable." + Fore.RESET)
#        sys.exit()
#    f2=open("service2.txt",'r')
#    url=f2.readline().replace("\r\n",'')
#    f2.close()
#    os.system("rm service2.txt")
#    return url

#def packet(url):
#    login_url=url
#    s=requests.session()
#    resp=s.get(login_url)
#    soup=BeautifulSoup(resp.text,'lxml')

#    print "--------------------------------------------"
#    print(Fore.CYAN+'[-] UPnP Service RESULT'+Fore.RESET)
#    if re.search('WANIPConnection', str(soup)):
#        print(Back.RED+"[*] The UPnP service is vulnerable." + Back.RESET)
#    else:
#        print(Fore.YELLOW+"[-] The UPnP service is not vulnerable." + Fore.RESET)
 
if __name__ == "__main__":
    ssdp()
    #location=ssdp()
    #url=filecontrol(location)
    #packet(url)
